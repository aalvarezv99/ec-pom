package Consultas;


import org.apache.log4j.Logger;

public class FuncionesSqlQuery {
	
private static Logger log = Logger.getLogger(FuncionesSqlQuery.class);
	
	static ConexionBase dbconector = new ConexionBase();

	public static void ejecutarFuncionOriginacion() {
		log.info("***Ejecutando Funcion Originacion ***");
		try {
			dbconector.ejecutorFunciones(
					"create or replace\r\n"
					+ "function public.calculos_automatizacion_pruebas (\r\n"
					+ "  p_monto integer,\r\n"
					+ "p_xperiodoPrima integer,\r\n"
					+ "p_tasaInicial numeric,\r\n"
					+ "p_plazo numeric,\r\n"
					+ "p_diasIniciales numeric,\r\n"
					+ "p_vlrCompasSaneamientos numeric,\r\n"
					+ "p_ingresos numeric,\r\n"
					+ "p_descLey numeric,\r\n"
					+ "p_descNomina numeric,\r\n"
					+ "p_pagaduria text \r\n"
					+ ")\r\n"
					+ "returns table (\r\n"
					+ "r_monto_solicitar int,\r\n"
					+ "r_cuota_corriente int,\r\n"
					+ "r_estudio_credito_iva int,\r\n"
					+ "r_fianza int,\r\n"
					+ "r_gmf4100 int,\r\n"
					+ "r_valor_intereses_iniciales int,\r\n"
					+ "r_prima_anticipada_seguro int,\r\n"
					+ "r_remanente_estimado int,\r\n"
					+ "r_monto_max_desembolsar int,\r\n"
					+ "r_capacidad_cliente int\r\n"
					+ ")\r\n"
					+ "language plpgsql\r\n"
					+ "as $function$\r\n"
					+ "\r\n"
					+ "declare\r\n"
					+ "-- ============================================================================\r\n"
					+ "-- Autor: Equipo automatizacion Pruebas.\r\n"
					+ "-- Fecha: 08/Nov/2021 Version 1.0 ThainerPerez - Jonathan Varon\r\n"
					+ "-- Se crea la funcion que retorna los calculos de originacion para los simuladores\r\n"
					+ "-- ============================================================================\r\n"
					+ "\r\n"
					+ "\r\n"
					+ "/*VARIABLES GLOBALES PARA LOS PARAMETROS*/\r\n"
					+ "v_tasa_estudio_credito numeric;\r\n"
					+ "\r\n"
					+ "v_tasa_fianza numeric;\r\n"
					+ "\r\n"
					+ "v_vlr_mes_dos numeric;\r\n"
					+ "\r\n"
					+ "v_tasa_uno numeric = p_tasaInicial / 100 ;\r\n"
					+ "\r\n"
					+ "v_tasa_dos numeric;\r\n"
					+ "\r\n"
					+ "v_tasaXmillonSeguro numeric;\r\n"
					+ "\r\n"
					+ "v_valor_millon numeric = 1000000;\r\n"
					+ "\r\n"
					+ "v_iva numeric = 1.19;\r\n"
					+ "\r\n"
					+ "v_diasMes numeric = 30;\r\n"
					+ "\r\n"
					+ "v_gmf4100 numeric = 0.004;\r\n"
					+ "\r\n"
					+ "v_capacidad numeric;\r\n"
					+ "\r\n"
					+ "v_colchon numeric;\r\n"
					+ "\r\n"
					+ "begin\r\n"
					+ "/*PARAMETROS GLOBALES*/\r\n"
					+ "\r\n"
					+ "/*consultar valores capitalizados*/\r\n"
					+ "select\r\n"
					+ "	segunda_tasa,\r\n"
					+ "	estudio_credito,\r\n"
					+ "	fianza,\r\n"
					+ "	mes_cambio_tasa\r\n"
					+ "into\r\n"
					+ "	v_tasa_dos,\r\n"
					+ "	v_tasa_estudio_credito,\r\n"
					+ "	v_tasa_fianza,\r\n"
					+ "	v_vlr_mes_dos\r\n"
					+ "from\r\n"
					+ "	configuracion_capitalizacion_cxc ccc\r\n"
					+ "where\r\n"
					+ "	tasa_inicial = p_tasaInicial;\r\n"
					+ "\r\n"
					+ "/*consultar tasaXmillon*/\r\n"
					+ "select\r\n"
					+ "	tasa_millon\r\n"
					+ "into\r\n"
					+ "	v_tasaXmillonSeguro\r\n"
					+ "from\r\n"
					+ "	seguro;\r\n"
					+ "\r\n"
					+ "/*consultar colchon*/\r\n"
					+ "select\r\n"
					+ "	pp.valor\r\n"
					+ "into\r\n"
					+ "	v_colchon\r\n"
					+ "from\r\n"
					+ "	pagaduria p\r\n"
					+ "inner join pagaduria_parametro pp on\r\n"
					+ "	pp.id_pagaduria = p.id\r\n"
					+ "inner join parametro pa on\r\n"
					+ "	pa.id = pp.id_parametro\r\n"
					+ "where\r\n"
					+ "	p.nombre = p_pagaduria\r\n"
					+ "	and pa.nombre = 'colchon';\r\n"
					+ "\r\n"
					+ "/**********************************CALCULOS DE CONCEPTOS PARA SIMULADORES********************************************/\r\n"
					+ "   \r\n"
					+ "	/*Calcular monto solicitado -  originacion*/\r\n"
					+ "r_monto_solicitar := p_monto + (p_monto * v_tasaXmillonSeguro / v_valor_millon * p_xperiodoPrima)\r\n"
					+ "                + (p_monto * (v_tasa_estudio_credito / 100) * v_iva) + (p_monto * (v_tasa_fianza / 100) * v_iva);\r\n"
					+ "\r\n"
					+ "raise notice 'Monto solicitar %',\r\n"
					+ "(r_monto_solicitar);\r\n"
					+ "\r\n"
					+ "	/*Calcular cuota corriente -  originacion*/\r\n"
					+ "   if(p_plazo < v_vlr_mes_dos) then\r\n"
					+ "    r_cuota_corriente := r_monto_solicitar / ((power((1 + v_tasa_uno), (p_plazo)) - 1) / (v_tasa_uno * power((1 + v_tasa_uno), (p_plazo))));\r\n"
					+ "else\r\n"
					+ "	v_tasa_dos = v_tasa_dos / 100;\r\n"
					+ "   r_cuota_corriente := round(r_monto_solicitar\r\n"
					+ "                    / ((power((1 + v_tasa_uno), (v_vlr_mes_dos - 1)) - 1) / (v_tasa_uno * power((1 + v_tasa_uno), (v_vlr_mes_dos - 1)))\r\n"
					+ "                    + ((power((1 + v_tasa_dos), (p_plazo - (v_vlr_mes_dos - 1))) - 1)\r\n"
					+ "                    / (v_tasa_dos * power((1 + v_tasa_dos), (p_plazo - (v_vlr_mes_dos - 1)))))\r\n"
					+ "                    / (power((1 + v_tasa_uno), (v_vlr_mes_dos - 1)))));\r\n"
					+ "                   \r\n"
					+ "   /*raise notice '>>>> valor credito %', (r_monto_solicitar);\r\n"
					+ "  raise notice '>>>> valor tasaUno  %', (v_tasa_uno);\r\n"
					+ " raise notice '>>>> valor mesDos  %', (v_vlr_mes_dos);\r\n"
					+ " raise notice '>>>> valor tazaDos  %', (v_tasa_dos);\r\n"
					+ "raise notice '>>>> valor plazo  %', (p_plazo);*/\r\n"
					+ "end if;\r\n"
					+ "\r\n"
					+ "raise notice 'Cuota Corriente %', (r_cuota_corriente);\r\n"
					+ "\r\n"
					+ "	/*Calcular Estudio Credito IVA -  originacion*/\r\n"
					+ "r_estudio_credito_iva := ((p_monto * v_tasa_estudio_credito) / 100) + (((p_monto * v_tasa_estudio_credito) / 100) * (v_iva - 1));\r\n"
					+ "\r\n"
					+ "raise notice 'valor Estudio Credito + Iva %', (r_estudio_credito_iva);\r\n"
					+ "\r\n"
					+ "	/*Calcular Fianza -  originacion*/\r\n"
					+ "r_fianza := ((p_monto * v_tasa_fianza) / 100) * v_iva;\r\n"
					+ "\r\n"
					+ "raise notice 'valor Fianza(s) %',\r\n"
					+ "(r_fianza);\r\n"
					+ "\r\n"
					+ "	/*Calcular Gmf4*1000 -  originacion*/\r\n"
					+ "r_gmf4100 := p_vlrCompasSaneamientos * v_gmf4100;\r\n"
					+ "\r\n"
					+ "raise notice 'Valor GMF4100 %', (r_gmf4100);\r\n"
					+ "\r\n"
					+ "	/*Calular Valor Intereses Iniciales -  originacion*/\r\n"
					+ "r_valor_intereses_iniciales := ((r_monto_solicitar * p_tasaInicial) / 100) * (p_diasIniciales / v_diasMes);\r\n"
					+ "\r\n"
					+ "raise notice 'Valor Intereses Iniciales %',\r\n"
					+ "(r_valor_intereses_iniciales);\r\n"
					+ "\r\n"
					+ "	/*Calcular Prima Anticipada Seguro -  originacion*/\r\n"
					+ "r_prima_anticipada_seguro := ((p_monto / v_valor_millon)*(v_tasaXmillonSeguro * p_xperiodoPrima));\r\n"
					+ "\r\n"
					+ "raise notice 'PrimaSeguro %',\r\n"
					+ "(r_prima_anticipada_seguro);\r\n"
					+ "\r\n"
					+ "	/*Calcular Remanente Estimado -  originacion*/\r\n"
					+ "\r\n"
					+ "r_remanente_estimado := r_monto_solicitar - (p_vlrCompasSaneamientos + r_gmf4100 + r_prima_anticipada_seguro + r_estudio_credito_iva + r_fianza);\r\n"
					+ "\r\n"
					+ "raise notice 'Remanente Estimado %', (r_remanente_estimado);\r\n"
					+ "\r\n"
					+ "	/*Calcular Monto Maximo a Desembolsar -  originacion*/\r\n"
					+ "\r\n"
					+ "v_capacidad := ((p_ingresos - p_descLey) / 2) - p_descNomina - v_colchon;\r\n"
					+ "raise notice 'Capacidad Cliente %', (v_capacidad);\r\n"
					+ "\r\n"
					+ "r_capacidad_cliente := v_capacidad;\r\n"
					+ "--Logica\r\n"
					+ "if (p_plazo < v_vlr_mes_dos) then\r\n"
					+ "	r_monto_max_desembolsar := v_capacidad * ((power((1 + v_tasa_uno),(p_plazo))) - 1) / (v_tasa_uno * power((1 + v_tasa_uno),(p_plazo)));\r\n"
					+ "else \r\n"
					+ "	r_monto_max_desembolsar := v_capacidad * ((power((1 + v_tasa_uno), (v_vlr_mes_dos - 1))) - 1)\r\n"
					+ "                    / (v_tasa_uno * power((1 + v_tasa_uno), (v_vlr_mes_dos - 1)))\r\n"
					+ "                    + (v_capacidad * ((power((1 + v_tasa_dos), (p_plazo - (v_vlr_mes_dos - 1)))) - 1)\r\n"
					+ "                    / (v_tasa_dos * power((1 + v_tasa_dos), (p_plazo - (v_vlr_mes_dos - 1)))))\r\n"
					+ "                    / power((1 + v_tasa_uno), (v_vlr_mes_dos - 1));\r\n"
					+ "end if;\r\n"
					+ "\r\n"
					+ "raise notice 'Monto Maximo a Desembolsar %', (r_monto_max_desembolsar);\r\n"
					+ "\r\n"
					+ "/**********************************RETORNO DE : CALCULOS DE CONCEPTOS PARA SIMULADORES********************************************/\r\n"
					+ "return query\r\n"
					+ "select coalesce (r_monto_solicitar,0),\r\n"
					+ "coalesce (r_cuota_corriente,0), \r\n"
					+ "coalesce (r_estudio_credito_iva,0),\r\n"
					+ "coalesce (r_fianza,0),\r\n"
					+ "coalesce (r_gmf4100,0),\r\n"
					+ "coalesce (r_valor_intereses_iniciales,0),\r\n"
					+ "coalesce (r_prima_anticipada_seguro,0),\r\n"
					+ "coalesce (r_remanente_estimado,0),\r\n"
					+ "coalesce (r_monto_max_desembolsar,0),\r\n"
					+ "coalesce (r_capacidad_cliente,0);\r\n"
					+ "end;\r\n"
					+ "\r\n"
					+ "$function$");
		} catch (Exception e) {
			log.error(e.getMessage());
		}
		
	}
}
